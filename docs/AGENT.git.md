---
id: git-agent
version: 1.0.0
owner: "@contextpilot-team"
category: ai-agents
gemini_model: gemini-1.5-flash
cloud_run_type: Service
events_in:
  - proposal.approved.v1
  - milestone.created.v1
  - spec.update.v1
  - rollback.requested.v1
events_out:
  - git.commit.v1
  - git.branch.created.v1
  - git.merge.v1
  - git.rollback.v1
resources:
  firestore:
    - git_history
    - branches
    - rollback_points
  pubsub:
    - topics: [git-events]
    - subs: [git-from-proposals, git-from-milestones]
prompts:
  ai_studio: "https://aistudio.google.com/prompts/GIT-001"
  local: "./prompts/git/commit_message.prompt.md"
contracts:
  inputs_schema: "schemas/git_events_v1.json"
  outputs_schema: "schemas/git_commit_v1.json"
slos:
  commit_latency_ms: 2000
  branch_creation_ms: 1000
  rollback_time_minutes: 5
---

# 🌳 Git Agent

## Purpose

Git Agent é o **único agente autorizado** a interagir diretamente com Git. Ele separa responsabilidades, implementa git-flow, gerencia branches e possibilita rollback de todas as ações.

**Core Principle:** Single responsibility - Git operations centralizadas, auditáveis e reversíveis.

---

## 🎯 Responsibilities

### 1. **Branch Management (Git-Flow)**

Git Agent implementa git-flow automatizado:

```
main (production)
  ├── develop (integration)
  │   ├── feature/extract-auth-service
  │   ├── feature/add-api-docs
  │   └── agent/spec-update-readme
  ├── release/v1.0.0
  └── hotfix/fix-auth-bug
```

**Branch Types:**
- `main` - Production, protected
- `develop` - Integration branch
- `feature/*` - User features
- `agent/*` - Agent-generated changes
- `release/*` - Release candidates
- `hotfix/*` - Emergency fixes

### 2. **Commit Management**

Git Agent cria commits semânticos e bem estruturados:

**Semantic Commits:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**
- `feat`: Nova feature
- `fix`: Bug fix
- `docs`: Documentação
- `refactor`: Refactoring
- `test`: Testes
- `chore`: Manutenção
- `agent`: Mudança por agente

**Example:**
```bash
git commit -m "agent(spec): Update API.md with /rewards/track endpoint

- Added POST /rewards/track documentation
- Included request/response examples
- Added error codes table

Generated by: Spec Agent
Proposal ID: cp_042
Approved by: dev_123"
```

### 3. **Change Application**

Quando proposal é aprovado, Git Agent executa:

```python
@git_agent.on_event("proposal.approved.v1")
async def apply_proposal(event):
    proposal = event.proposal
    
    # 1. Create feature branch
    branch_name = f"agent/{proposal.type}-{proposal.id}"
    create_branch(branch_name, base="develop")
    
    # 2. Apply changes
    for change in proposal.changes:
        if change.action == "create":
            write_file(change.file, change.content)
        elif change.action == "modify":
            apply_diff(change.file, change.diff)
        elif change.action == "delete":
            delete_file(change.file)
    
    # 3. Commit with semantic message
    commit_message = generate_commit_message(proposal)
    git_commit(commit_message)
    
    # 4. Create rollback point
    create_rollback_point(
        branch=branch_name,
        commit=get_current_commit(),
        proposal_id=proposal.id
    )
    
    # 5. Emit event
    emit_event("git.commit.v1", {
        "branch": branch_name,
        "commit": get_current_commit(),
        "proposal_id": proposal.id,
        "files_changed": [c.file for c in proposal.changes]
    })
```

### 4. **Rollback System**

Git Agent permite reverter qualquer mudança:

**Rollback Points:**
```json
{
  "rollback_id": "rb_001",
  "created_at": "2025-10-14T10:00:00Z",
  "branch": "agent/refactor-auth-service",
  "commit_hash": "abc123",
  "proposal_id": "cp_042",
  "files_affected": ["src/auth.py", "src/services/auth.py"],
  "can_rollback": true,
  "rolled_back": false
}
```

**Rollback Flow:**
```python
@git_agent.on_event("rollback.requested.v1")
async def rollback(event):
    rollback_point = get_rollback_point(event.rollback_id)
    
    # Check if rollback is safe
    if not can_rollback(rollback_point):
        emit_error("Rollback unsafe: branch has been merged")
        return
    
    # 1. Checkout original branch
    git_checkout(rollback_point.branch)
    
    # 2. Revert commits
    commits_to_revert = get_commits_since(rollback_point.commit)
    for commit in reversed(commits_to_revert):
        git_revert(commit)
    
    # 3. Mark as rolled back
    mark_rollback_point_used(rollback_point.id)
    
    # 4. Emit event
    emit_event("git.rollback.v1", {
        "rollback_id": rollback_point.id,
        "reverted_commits": [c.hash for c in commits_to_revert],
        "status": "success"
    })
```

### 5. **Merge Strategy**

Git Agent gerencia merges entre branches:

```python
@git_agent.on_event("proposal.merge_requested.v1")
async def merge_proposal(event):
    source_branch = event.branch
    target_branch = event.target or "develop"
    
    # 1. Check merge conflicts
    conflicts = check_conflicts(source_branch, target_branch)
    if conflicts:
        emit_event("git.merge.conflict.v1", {
            "branch": source_branch,
            "conflicts": conflicts
        })
        return
    
    # 2. Run tests first
    ci_status = await wait_for_ci(source_branch)
    if ci_status != "success":
        emit_error("CI failed, merge blocked")
        return
    
    # 3. Merge
    git_checkout(target_branch)
    git_merge(source_branch, strategy="no-ff")  # Keep history
    
    # 4. Cleanup
    if event.delete_source_branch:
        git_branch_delete(source_branch)
    
    # 5. Emit event
    emit_event("git.merge.v1", {
        "source": source_branch,
        "target": target_branch,
        "merge_commit": get_current_commit()
    })
```

---

## 🔄 Git-Flow Implementation

### Feature Development Flow

```
1. Dev starts feature
   └─► Git Agent: create feature/new-api
   
2. Agent proposes improvement
   └─► Git Agent: create agent/refactor-auth
   
3. Both developed in parallel
   
4. Tests pass
   └─► Git Agent: merge to develop
   
5. Release time
   └─► Git Agent: create release/v1.0.0
   
6. Deploy to staging → prod
   └─► Git Agent: merge release to main
   └─► Git Agent: tag v1.0.0
```

### Hotfix Flow

```
1. Bug found in production (main)
   └─► Git Agent: create hotfix/fix-auth-bug from main
   
2. Fix implemented
   
3. Tests pass
   └─► Git Agent: merge hotfix to main
   └─► Git Agent: merge hotfix to develop (backport)
   └─► Git Agent: tag v1.0.1
```

---

## 📊 Commit Message Generation

Git Agent usa Gemini para gerar mensagens descritivas:

**Prompt Template:**
```
Generate a semantic commit message for this change:

Type: {{proposal.type}}
Files changed: {{files}}
Lines added: {{lines_added}}
Lines removed: {{lines_removed}}

Proposal description:
{{proposal.description}}

Changes:
{{proposal.changes}}

Format:
<type>(<scope>): <subject>

<body with bullet points>

<footer with metadata>

Requirements:
- Subject ≤ 50 chars
- Body explains WHY and WHAT
- Footer includes: Generated by, Proposal ID, Approved by
```

**Example Output:**
```
agent(auth): Extract authentication logic to AuthService

- Removed duplicated auth logic from 3 files
- Created centralized AuthService class
- Maintained backward compatibility
- Added unit tests for AuthService

Generated by: Strategy Agent
Proposal ID: cp_042
Approved by: dev_123
Closes: #156
```

---

## 🛡️ Safety Mechanisms

### 1. Protected Branches

```yaml
# .contextpilot/git-rules.yml
protected_branches:
  - main
  - develop

rules:
  main:
    require_pull_request: true
    require_reviews: 2
    require_ci_pass: true
    no_force_push: true
    no_delete: true
  
  develop:
    require_pull_request: true
    require_reviews: 1
    require_ci_pass: true
```

### 2. Pre-Commit Checks

Git Agent roda checks antes de commit:

```python
@git_agent.pre_commit
async def validate_commit():
    checks = []
    
    # Check 1: No secrets
    secrets_found = scan_for_secrets(staged_files())
    if secrets_found:
        checks.append(ValidationError(
            "Secrets detected in commit",
            files=secrets_found
        ))
    
    # Check 2: Linting passes
    lint_errors = run_linter(staged_files())
    if lint_errors:
        checks.append(ValidationError(
            "Linting failed",
            errors=lint_errors
        ))
    
    # Check 3: Tests pass
    test_results = run_tests()
    if not test_results.success:
        checks.append(ValidationError(
            "Tests failed",
            failures=test_results.failures
        ))
    
    return ValidationResult(valid=len(checks) == 0, issues=checks)
```

### 3. Rollback Validation

```python
def can_rollback(rollback_point) -> bool:
    # Check 1: Branch still exists
    if not branch_exists(rollback_point.branch):
        return False
    
    # Check 2: Not merged to main
    if is_merged_to(rollback_point.branch, "main"):
        return False
    
    # Check 3: No conflicting changes
    if has_conflicts_with_current_state(rollback_point):
        return False
    
    return True
```

---

## 📋 Event Schemas

### git.commit.v1

```json
{
  "event_id": "evt_git_001",
  "timestamp": "2025-10-14T10:00:00Z",
  "branch": "agent/refactor-auth-service",
  "commit_hash": "abc123def456",
  "message": "agent(auth): Extract authentication logic",
  "files_changed": ["src/auth.py", "src/services/auth.py"],
  "lines_added": 50,
  "lines_removed": 120,
  "author": "git-agent",
  "proposal_id": "cp_042",
  "rollback_point_id": "rb_001"
}
```

### git.rollback.v1

```json
{
  "event_id": "evt_git_002",
  "timestamp": "2025-10-14T11:00:00Z",
  "rollback_point_id": "rb_001",
  "branch": "agent/refactor-auth-service",
  "reverted_commits": ["abc123", "def456"],
  "reason": "CI failed after merge",
  "initiated_by": "dev_123",
  "status": "success"
}
```

---

## 🎯 API Endpoints

### Create Branch

```http
POST /git/branches/create
Authorization: Bearer <token>

{
  "name": "feature/new-api",
  "base": "develop",
  "type": "feature"
}

Response:
{
  "branch": "feature/new-api",
  "commit": "abc123",
  "created_at": "2025-10-14T10:00:00Z"
}
```

### Rollback

```http
POST /git/rollback
Authorization: Bearer <token>

{
  "rollback_point_id": "rb_001",
  "reason": "CI failed"
}

Response:
{
  "status": "success",
  "reverted_commits": ["abc123", "def456"],
  "current_commit": "xyz789"
}
```

### Get Branch History

```http
GET /git/branches/agent/refactor-auth-service/history

Response:
{
  "branch": "agent/refactor-auth-service",
  "commits": [
    {
      "hash": "abc123",
      "message": "agent(auth): Extract AuthService",
      "timestamp": "2025-10-14T10:00:00Z",
      "files": ["src/auth.py"]
    }
  ],
  "rollback_points": [
    {
      "id": "rb_001",
      "commit": "abc123",
      "can_rollback": true
    }
  ]
}
```

---

## 🔐 Security

### Secrets Scanning

```python
@git_agent.pre_commit
async def scan_secrets():
    patterns = [
        r'api[_-]?key\s*=\s*["\'][\w\-]+["\']',
        r'password\s*=\s*["\'].+["\']',
        r'AKIA[0-9A-Z]{16}',  # AWS keys
        r'ghp_[0-9a-zA-Z]{36}',  # GitHub PAT
    ]
    
    for file in staged_files():
        content = read_file(file)
        for pattern in patterns:
            if re.search(pattern, content):
                raise SecurityError(
                    f"Potential secret in {file}",
                    pattern=pattern
                )
```

### Audit Log

Every Git operation is logged:

```json
{
  "audit_id": "aud_001",
  "timestamp": "2025-10-14T10:00:00Z",
  "operation": "commit",
  "branch": "agent/refactor-auth",
  "user": "dev_123",
  "agent": "git-agent",
  "details": {
    "files_changed": 4,
    "proposal_id": "cp_042"
  },
  "ip": "203.0.113.1"
}
```

---

## 📊 Metrics

### SLOs

| Metric | Target | Current |
|--------|--------|---------|
| Commit Latency | < 2s | 1.2s |
| Branch Creation | < 1s | 0.8s |
| Rollback Time | < 5min | 3.5min |
| Rollback Success Rate | > 95% | 98% |

### Dashboards

**Git Operations:**
- Commits per day (by type)
- Branches created (feature vs agent)
- Rollbacks (frequency, reasons)
- Merge conflicts (rate)

---

## 🧪 Test Vectors

### Vector 1: Apply Proposal

**Input:**
```json
{
  "event": "proposal.approved.v1",
  "proposal_id": "cp_042",
  "changes": [
    {
      "file": "src/auth.py",
      "action": "modify",
      "diff": "..."
    }
  ]
}
```

**Expected:**
- ✅ Branch created: `agent/refactor-cp_042`
- ✅ Changes applied
- ✅ Commit created with semantic message
- ✅ Rollback point saved
- ✅ Event emitted: `git.commit.v1`

### Vector 2: Rollback

**Input:**
```json
{
  "event": "rollback.requested.v1",
  "rollback_point_id": "rb_001"
}
```

**Expected:**
- ✅ Validation passed
- ✅ Commits reverted
- ✅ Branch restored to previous state
- ✅ Event emitted: `git.rollback.v1`

---

**Status**: 📐 **Architecture defined**  
**Next**: Implement git-flow automation  
**Owner**: Git Agent Team

